## Swarm을 이용한 Fabric 멀티호스팅 #2

### Ubuntu 방화벽

> **$ sudo ufw status**
>
> *Status: Inactive*
>
> *Active라면 **sudo ufw disabled**로 방화벽 해제*

<br>

### Swarm 컨테이너

- Swarm 



- manager 노드에서 overlay 네트워크 생성

> **$ docker network create --attachable --driver overlay my_net**

<br>

- manager 노드에서 first-network generate

> **$ ./byfn.sh generate**
>
> *channel-artifacts, crypto-config 디렉토리 생성됨*

<br>

- worker 노드로 복사 

> **$ scp -r channel-artifacts ubuntu@hlf2:/home/ubuntu/fabric-samples/first-network/**
>
> **scp -r channel-artifacts ubuntu@hlf2:/home/ubuntu/fabric-samples/first-network/fabric-multi-network-fabric-1.3**

<br>

- secret key 파일 읽기 권한 부여

> **$ chmod 750 afd9ce9efeba07731c9f216fba4b96b0e37efd6b778606bc59888ff4df04b016_sk**
>
> *파일명이 녹색으로 변경된 것을 확인할 수 있음*

<br>

- CA 서버 구동

> \$ docker run --rm -it --network="my_net" --name ca.example.com -p 7054:7054 \
> -e FABRIC_CA_HOME=/etc/hyperledger/fabric-ca-server \
> -e FABRIC_CA_SERVER_CA_NAME=ca.example.com \
> -e FABRIC_CA_SERVER_CA_CERTFILE=/etc/hyperledger/fabric-ca-server-config/ca.org1.example.com-cert.pem \
> -e FABRIC_CA_SERVER_CA_KEYFILE=/etc/hyperledger/fabric-ca-server-config/afd9ce9efeba07731c9f216fba4b96b0e37efd6b778606bc59888ff4df04b016_sk \
> -v $(pwd)/crypto-config/peerOrganizations/org1.example.com/ca/:/etc/hyperledger/fabric-ca-server-config \
> -e CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=hyp-net hyperledger/fabric-ca \
> sh -c 'fabric-ca-server start -b admin:adminpw -d'

<br>

- Orderer 구동

> \$ docker run --rm -it --network="fabric" --name orderer.example.com -p 7050:7050 \
> -e ORDERER_GENERAL_LOGLEVEL=debug -e ORDERER_GENERAL_LISTENADDRESS=0.0.0.0 \
> -e ORDERER_GENERAL_LISTENPORT=7050 -e ORDERER_GENERAL_GENESISMETHOD=file \
> -e ORDERER_GENERAL_GENESISFILE=/var/hyperledger/orderer/orderer.genesis.block \
> -e ORDERER_GENERAL_LOCALMSPID=OrdererMSP \
> -e ORDERER_GENERAL_LOCALMSPDIR=/var/hyperledger/orderer/msp \
> -e ORDERER_GENERAL_TLS_ENABLED=false \
> -e CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=fabric \
> -v $(pwd)/channel-artifacts/genesis.block:/var/hyperledger/orderer/orderer.genesis.block \
> -v $(pwd)/crypto-config/ordererOrganizations/example.com/orderers/orderer.example.com/msp:\
> /var/hyperledger/orderer/msp -w /opt/gopath/src/github.com/hyperledger/fabric hyperledger/fabric-orderer orderer

<br>

- CouchDB 구동

> $ docker run --rm -it --network="fabric" --name couchdb0 -p 5984:5984 \
> -e COUCHDB_USER= \
> -e COUCHDB_PASSWORD= \
> -e CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=fabric hyperledger/fabric-couchdb

<br>

- Peer0 구동

> \$ docker run --rm -it --link orderer.example.com:orderer.example.com --network="fabric" --name \
> peer0.org1.example.com -p 8051:7051 -p 8053:7053 \
> -e CORE_LEDGER_STATE_STATEDATABASE=CouchDB \
> -e CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb0:5984 -e \
> CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME= \
> -e CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD= \
> -e CORE_PEER_ADDRESSAUTODETECT=true -e CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock -e \
> CORE_LOGGING_LEVEL=DEBUG -e CORE_PEER_NETWORKID=peer0.org1.example.com \
> -e CORE_NEXT=true -e CORE_PEER_ENDORSER_ENABLED=true \
> -e CORE_PEER_ID=peer0.org1.example.com -e CORE_PEER_PROFILE_ENABLED=true \
> -e CORE_PEER_COMMITTER_LEDGER_ORDERER=orderer.example.com:7050 \
> -e CORE_PEER_GOSSIP_IGNORESECURITY=true \
> -e CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=fabric \
> -e CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer0.org1.example.com:7051 \
> -e CORE_PEER_TLS_ENABLED=false -e CORE_PEER_GOSSIP_USELEADERELECTION=false \
> -e CORE_PEER_GOSSIP_ORGLEADER=true \
> -e CORE_PEER_LOCALMSPID=Org1MSP -v /var/run/:/host/var/run/ \
> -v $(pwd)/crypto-config/peerOrganizations/org1.example.com/peers/peer0.org1.example.com/msp\
> :/etc/hyperledger/fabric/msp \
> -w /opt/gopath/src/github.com/hyperledger/fabric/peer hyperledger/fabric-peer peer node start

<br>

- CouchDB1 구동

> $ docker run --rm -it --network="fabric" --name couchdb1 -p 6984:5984 \
> -e COUCHDB_USER= \
> -e COUCHDB_PASSWORD= \
> -e CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=fabric hyperledger/fabric-couchdb

<br>

- Peer1 구동

> \$ docker run --rm -it --link orderer.example.com:orderer.example.com --network="fabric" \
> --link peer0.org1.example.com:peer0.org1.example.com \
> --name peer1.org1.example.com -p 9051:7051 -p 9053:7053 \
> -e CORE_LEDGER_STATE_STATEDATABASE=CouchDB \
> -e CORE_LEDGER_STATE_COUCHDBCONFIG_COUCHDBADDRESS=couchdb1:5984 \
> -e CORE_LEDGER_STATE_COUCHDBCONFIG_USERNAME= \
> -e CORE_LEDGER_STATE_COUCHDBCONFIG_PASSWORD= \
> -e CORE_PEER_ADDRESSAUTODETECT=true -e CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock \
> -e CORE_LOGGING_LEVEL=DEBUG -e CORE_PEER_NETWORKID=peer1.org1.example.com \
> -e CORE_NEXT=true -e CORE_PEER_ENDORSER_ENABLED=true \
> -e CORE_PEER_ID=peer1.org1.example.com -e CORE_PEER_PROFILE_ENABLED=true \
> -e CORE_PEER_COMMITTER_LEDGER_ORDERER=orderer.example.com:7050 \
> -e CORE_PEER_GOSSIP_IGNORESECURITY=true \
> -e CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=fabric \
> -e CORE_PEER_GOSSIP_BOOTSTRAP=peer0.org1.example.com:7051 \
> -e CORE_PEER_GOSSIP_EXTERNALENDPOINT=peer1.org1.example.com:7051 \
> -e CORE_PEER_TLS_ENABLED=false -e CORE_PEER_GOSSIP_USELEADERELECTION=false \
> -e CORE_PEER_GOSSIP_ORGLEADER=true \
> -e CORE_PEER_LOCALMSPID=Org1MSP -v /var/run/:/host/var/run/ \
> -v $(pwd)/crypto-config/peerOrganizations/org1.example.com/peers/peer1.org1.example.com/msp\
> :/etc/hyperledger/fabric/msp \
> -w /opt/gopath/src/github.com/hyperledger/fabric/peer hyperledger/fabric-peer peer node start

<br>

- CLI 구동

> \$ docker run --rm -it --network="fabric" --name cli \
> --link orderer.example.com:orderer.example.com \
> --link peer0.org1.example.com:peer0.org1.example.com \
> --link peer1.org1.example.com:peer1.org1.example.com \
> -p 12051:7051 -p 12053:7053 \
> -e GOPATH=/opt/gopath \
> -e CORE_PEER_LOCALMSPID=Org1MSP \
> -e CORE_PEER_TLS_ENABLED=false -e CORE_VM_ENDPOINT=unix:///host/var/run/docker.sock -e CORE_LOGGING_LEVEL=DEBUG -e CORE_PEER_ID=cli \
> -e CORE_PEER_ADDRESS=peer0.org1.example.com:7051 -e CORE_PEER_NETWORKID=cli \
> -e CORE_PEER_MSPCONFIGPATH=\
> /opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/peerOrganizations/\
> org1.example.com/users/Admin@org1.example.com/msp \
> -e CORE_VM_DOCKER_HOSTCONFIG_NETWORKMODE=fabric \
> -v /var/run/:/host/var/run/ \
> -v $(pwd)/chaincode/:/opt/gopath/src/github.com/hyperledger/fabric/examples/chaincode/go \
> -v $(pwd)/crypto-config:/opt/gopath/src/github.com/hyperledger/fabric/peer/crypto/ \
> -v $(pwd)/scripts:/opt/gopath/src/github.com/hyperledger/fabric/peer/scripts/ \
> -v $(pwd)/channel-artifacts:/opt/gopath/src/github.com/hyperledger/fabric/peer/channel-artifacts -w \
> /opt/gopath/src/github.com/hyperledger/fabric/peer hyperledger/fabric-tools /bin/bash \
> -c './scripts/script.sh'

<br>